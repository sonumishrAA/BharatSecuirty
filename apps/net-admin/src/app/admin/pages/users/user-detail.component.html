<div class="user-detail-container">
    <div class="page-header">
        <button class="btn btn-back" (click)="goBack()">â† Back to Users</button>
        <h2>ğŸ‘¤ User Details</h2>
    </div>

    @if (isLoading) {
    <div class="loading">Loading user details...</div>
    }

    @if (!isLoading && user) {
    <div class="detail-grid">
        <!-- User Info Card -->
        <div class="card user-card">
            <div class="card-header">
                <h3>ğŸ“‹ User Information</h3>
            </div>
            <div class="card-body">
                <div class="info-grid">
                    <div class="info-item">
                        <span class="icon">ğŸ†”</span>
                        <div>
                            <label>User ID</label>
                            <code>{{ user.id }}</code>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="icon">ğŸ“§</span>
                        <div>
                            <label>Email</label>
                            <span>{{ user.email }}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="icon">ğŸ”‘</span>
                        <div>
                            <label>Current Password</label>
                            @if (user.temp_password) {
                            <code class="password">{{ user.temp_password }}</code>
                            } @else {
                            <span class="text-muted">Not set</span>
                            }
                        </div>
                    </div>
                    <div class="info-item">
                        <span class="icon">ğŸ“…</span>
                        <div>
                            <label>Joined</label>
                            <span>{{ formatDate(user.created_at) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Card -->
        <div class="card bookings-card">
            <div class="card-header">
                <h3>ğŸ“¦ Bookings ({{ user.bookings?.length || 0 }})</h3>
            </div>
            <div class="card-body">
                @for (booking of user.bookings; track booking.id) {
                <div class="booking-item" [class.active]="selectedBookingId === booking.id"
                    (click)="loadStatusHistory(booking.id); loadMessages(booking.id)">
                    <div class="booking-header">
                        <span class="service-icon">ğŸ›¡ï¸</span>
                        <div>
                            <strong>{{ booking.service_type || booking.service_title || 'General Inquiry' }}</strong>
                            <span class="date">{{ formatDate(booking.created_at) }}</span>
                        </div>
                        <span class="status-badge" [class]="booking.status">{{ getStatusIcon(booking.status) }} {{
                            booking.status }}</span>
                        <button class="btn-delete" (click)="$event.stopPropagation(); deleteBooking(booking.id)"
                            title="Delete Booking">ğŸ—‘ï¸</button>
                    </div>
                    <div class="booking-details">
                        <div class="detail-row"><span>ğŸ‘¤</span> {{ booking.contact_name }}</div>
                        <div class="detail-row" *ngIf="booking.company"><span>ğŸ¢</span> {{ booking.company }}</div>
                        <div class="detail-row" *ngIf="booking.phone"><span>ğŸ“</span> {{ booking.phone }}</div>
                        <div class="detail-row" *ngIf="booking.progress"><span>ğŸ“Š</span> Progress: {{ booking.progress
                            }}%</div>
                    </div>
                    @if (booking.message) {
                    <div class="booking-message">
                        <strong>ğŸ’¬ Message:</strong>
                        <p>{{ booking.message }}</p>
                    </div>
                    }
                </div>
                }
            </div>
        </div>

        <!-- Status Update Card -->
        <div class="card status-card">
            <div class="card-header">
                <h3>ğŸ”„ Update Status</h3>
            </div>
            <div class="card-body">
                @if (selectedBookingId) {
                <div class="form-group">
                    <label>New Status</label>
                    <select [(ngModel)]="newStatus">
                        <option value="">-- Select Status --</option>
                        @for (opt of statusOptions; track opt.value) {
                        <option [value]="opt.value">{{ opt.label }}</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Progress (%)</label>
                    <input type="range" [(ngModel)]="newProgress" min="0" max="100">
                    <span class="progress-value">{{ newProgress }}%</span>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea [(ngModel)]="statusNotes" rows="3"
                        placeholder="Add notes about this status change..."></textarea>
                </div>
                <button class="btn btn-primary" (click)="updateStatus()" [disabled]="!newStatus">Update Status</button>
                } @else {
                <p class="text-muted">Select a booking to update its status</p>
                }
            </div>
        </div>

        <!-- Status Timeline Card -->
        <div class="card timeline-card">
            <div class="card-header">
                <h3>ğŸ“œ Status Timeline</h3>
            </div>
            <div class="card-body">
                @if (statusHistory.length === 0) {
                <p class="text-muted">No status changes yet</p>
                }
                <div class="timeline">
                    @for (entry of statusHistory; track entry.id) {
                    <div class="timeline-item">
                        <div class="timeline-icon">{{ getStatusIcon(entry.new_status) }}</div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="status-change">{{ entry.old_status || 'created' }} â†’ {{ entry.new_status
                                    }}</span>
                                <span class="timeline-date">{{ formatDate(entry.created_at) }}</span>
                            </div>
                            <div class="timeline-by">by {{ entry.changed_by_email }}</div>
                            @if (entry.notes) {
                            <div class="timeline-notes">{{ entry.notes }}</div>
                            }
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- Chat Card -->
        <div class="card chat-card">
            <div class="card-header">
                <h3>ğŸ’¬ Chat with Client</h3>
            </div>
            <div class="card-body">
                <div class="chat-messages">
                    @for (msg of messages; track msg.id) {
                    <div class="message" [class.admin]="msg.sender_role === 'admin'"
                        [class.user]="msg.sender_role === 'user'">
                        <div class="message-header">
                            <span class="sender">{{ msg.sender_role === 'admin' ? 'Me' : 'ğŸ‘¤ Client' }}</span>
                            <span class="time">{{ formatDateTime(msg.created_at) }}</span>
                        </div>
                        <div class="message-content">
                            {{ msg.content }}
                            @if (msg.attachment_url) {
                            <div class="attachment-link">
                                <a [href]="getAttachmentUrl(msg.attachment_url)" target="_blank">
                                    ğŸ“ View Attachment
                                </a>
                            </div>
                            }
                        </div>
                    </div>
                    }
                    @if (messages.length === 0) {
                    <div class="text-muted" style="text-align: center; padding: 2rem; opacity: 0.6;">
                        <p>No messages yet.</p>
                    </div>
                    }
                </div>

                @if (chatBookingId) {
                <div class="chat-input-area">
                    <div class="text-input">
                        <textarea [(ngModel)]="chatMessage" placeholder="Type your message..." rows="1"></textarea>
                        <button (click)="sendMessage()" [disabled]="!chatMessage.trim() && !selectedFile">Send</button>
                    </div>
                    <div class="file-upload">
                        <input type="file" (change)="onFileSelected($event)">
                    </div>
                    @if (selectedFile) {
                    <div class="selected-file">
                        ğŸ“ {{ selectedFile.name }}
                        <span (click)="selectedFile = null">âœ–</span>
                    </div>
                    }
                </div>
                }
            </div>
        </div>
    </div>
    }
</div>